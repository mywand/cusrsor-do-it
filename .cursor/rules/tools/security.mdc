---
description: Security baseline & practices (安全基线与实践)
globs: []
alwaysApply: true
---
最近更新: 2025-09-18
# Security Baseline & Practices

## 1. Threat Modeling (威胁建模)
- 识别资产：用户数据 / 密钥 / 交易记录 / 配置。
- 识别攻击面：API 入口 / 消息队列 / 管理端 / 文件上传 / 定时任务。
- STRIDE（可选）：Spoofing / Tampering / Repudiation / Information Disclosure / DoS / Elevation of Privilege。
- 输出：高风险场景 -> 缓解措施 -> 剩余风险。

## 2. 输入验证 & 数据清理
| 类型 | 策略 |
| ---- | ---- |
| 字符串 | 长度限制 / 白名单字符 / 去除控制字符 |
| 数字 | 范围校验 / 类型严格解析 |
| 枚举 | 固定值集合校验 |
| 文件 | 扩展名 + MIME 双重校验；限制大小；随机化文件名 |
| JSON/XML | Schema 校验；禁用外部实体 (XXE) |

## 3. 鉴权与认证
- 认证：JWT / OAuth2 / Session；访问令牌有效期 + 刷新机制。
- 鉴权：RBAC（角色） + ABAC（属性） -> 关键资源显式权限检查。
- 最小权限原则：服务账号、数据库账号权限最小化。
- 禁止硬编码凭证；统一 Secret 管理（Vault / KMS / 环境变量）。

## 4. 会话与令牌
- JWT：签名算法 HS256/RS256；声明最小化，不放敏感；设置过期 `exp`。
- 防重放：nonce 或一次性 token；关键变更加二次校验。
- 退出/吊销：刷新令牌黑名单或版本号策略。

## 5. 加密与敏感数据
| 场景 | 建议 |
| ---- | ---- |
| 传输 | HTTPS(TLS1.2+) 强制；HSTS；禁用弱套件 |
| 存储 | 敏感字段加密（AES-256-GCM）或哈希（bcrypt/argon2） |
| 密钥管理 | 不写入代码库；周期轮换；访问审计 |
| 日志 | 掩码显示（只保留 3~4 位脱敏） |

## 6. 防注入与序列化风险
- 参数化查询（PreparedStatement / 参数绑定）。
- 禁用拼接 SQL / Shell / LDAP / NoSQL 动态语句。
- JSON 反序列化：限制类型 / 使用白名单；禁用未知多态。
- XML：禁用外部实体 `DOCTYPE`。

## 7. CSRF / XSS / SSRF
| 风险 | 缓解 |
| ---- | ---- |
| CSRF | SameSite=Lax/Strict Cookie；CSRF Token；幂等设计 |
| XSS | 输出编码；输入清理；内容安全策略(CSP) |
| SSRF | 目标地址白名单；禁止访问 127.* / 内网段 |
| 点击劫持 | X-Frame-Options / CSP frame-ancestors |

## 8. 上传与文件处理
- 隔离存储（非应用执行目录）。
- 病毒扫描（可异步）。
- EXIF / 隐藏数据清理（图片）。
- 强制 Content-Type 与扩展名匹配。

## 9. 访问控制与多租户
- 租户隔离：数据过滤（tenantId）防止越权。
- 管理操作与用户操作日志分离审计。
- 横向权限：资源所有者校验；纵向权限：角色/策略判断。

## 10. 安全日志与审计
- 记录：登录 / 登出 / 权限变更 / 敏感资源访问 / 配置调整。
- 不记录：密码、密钥、完整 Token、个人敏感内容。
- 提供 traceId + actorId + action + resource + result + ip。

## 11. 依赖与供应链安全
- 组件升级前扫描（OWASP Dependency Check / Snyk）。
- 锁定版本；避免引用不明镜像/仓库。
- CI 加入许可证合规检查（GPL、AGPL 评估）。

## 12. Rate Limit / Abuse 防护
- 策略：IP + 用户 + Token 维度限流。
- 黑名单/灰度：异常高频行为加入观察列表。
- 指标：限流命中率 / 拒绝数 / 延迟分布。

## 13. 可用性与 DoS 防护
- 读写隔离 + 缓存保护后端。
- 分页/流式接口限制最大条数。
- 复杂计算/导出作业：异步 + 队列 + 进度查询。

## 14. Secret Rotation & Key Lifecycle
- 记录：创建时间 / 上次轮换 / 使用范围。
- 自动轮换策略（每 90 天或高风险后）。
- 吊销：发现泄漏 -> 即刻标记失效 + 强制刷新下游。

## 15. 生产变更安全检查表
- [ ] 依赖扫描通过
- [ ] 无硬编码凭证
- [ ] 配置加密生效
- [ ] 管理接口鉴权
- [ ] 关键操作审计有日志
- [ ] 限流/熔断开启
- [ ] TLS 证书未过期

## 16. 安全事件响应
- 建立分级：P0(数据泄露)/P1(大面积不可用)/P2(局部功能异常)。
- 预置联系人：安全负责人 / 运维 / 开发负责人。
- 事件处理流程：检测 -> 分析 -> 隔离 -> 修复 -> 复盘 -> 改进。

## 17. 与其他规范的关系
- 通用编码：`coding-standards.mdc`
- 测试策略：`testing.mdc`
- 可观测：`observability.mdc`
- 文档体系：`document.mdc`

(可后续扩展攻防、零信任、合规条款专章。)
## 18. 常见错误示例 vs 推荐写法
| 场景 | 错误示例 (Anti-pattern) | 风险 | 推荐写法 |
| ---- | ----------------------- | ---- | -------- |
| 硬编码密钥 | const SECRET = 'abcd1234'; | 泄漏、无法轮换 | 从环境变量/Secret 管理加载，启动时校验为空即失败 |
| SQL 拼接 | `"SELECT * FROM user WHERE name='"+name+"'"` | SQL 注入 | 使用参数化 `SELECT * FROM user WHERE name = ?` |
| JWT 不设置过期 | 只签名不含 exp | 永久有效被盗即长期可用 | 设置 exp + 短有效期 + 刷新机制 |
| 宽泛 CORS | Access-Control-Allow-Origin: * 并允许凭证 | 跨站请求滥用 | 仅允许白名单域；禁止带凭证时通配符 |
| 未校验上传类型 | 直接保存用户上传文件 | 木马 / 脚本执行 | 校验 MIME + 扩展；存储于隔离对象存储，不可执行 |
| 日志记录敏感数据 | 打印全量 Token / 密码 | 数据泄露 | 打码显示，仅记录后 4 位或散列 |
| 异常直接返回内部信息 | 返回 stack trace | 信息泄露 | 返回通用错误码，内部记录详细日志 |
| 重放攻击防护缺失 | 接口接受重复相同支付请求 | 重复扣款 | 幂等键 + 请求唯一nonce/时间窗口校验 |
| 不限制文件大小 | 任意超大上传 | DoS / 资源耗尽 | 设置 Content-Length 上限；超限拒绝 |
| 忽略依赖漏洞扫描 | 未运行审计 | 已知漏洞被利用 | CI 集成 dependency scan + 定期升级 |
| 缺少速率限制 | 登录无限尝试 | 暴力破解 | 针对 IP/账号 throttle + 失败计数锁定 |
| 密码哈希使用 MD5 | md5(password) | 易破解 | bcrypt/argon2 并设置 cost 参数 |
| 未验证回调来源 | 第三方回调直接处理 | 伪造回调 | 校验签名/来源 IP/时间戳 |
| 生产调试端点暴露 | /actuator 全量开放 | 信息泄露 | 限制IP + 鉴权 + 只开放必要端点 |
| XSS 直接注入 innerHTML | element.innerHTML = userInput | 脚本注入 | 使用 textContent 或可信模板引擎；必要时 sanitize |
| SSRF 不做过滤 | 允许任意 URL 抓取 | 内网探测 | 仅允许 HTTP/HTTPS + 白名单域；解析后再校验 IP |

速用审查列表：
- [ ] 是否仍存在字符串硬编码密钥/密码？
- [ ] 是否所有外部输入都做了长度/类型/枚举限制？
- [ ] 是否开启速率限制与幂等保护？
- [ ] 日志中是否可能泄露敏感字段？
- [ ] 依赖扫描与补丁策略是否落实？
