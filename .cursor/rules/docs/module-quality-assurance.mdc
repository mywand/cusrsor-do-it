---
description: Module design quality assurance guidelines (模块设计质量保障指南)
globs: []
alwaysApply: false
---
最近更新: 2025-10-28
最近审阅: 2025-10-28
# 模块设计质量保障指南

> **文件编码**：UTF-8, 无 BOM
> 
> **本文档内容**：第10-15章 - 质量保障规范

## 📚 文档导航

| 文档 | 内容 |
|------|------|
| 📖 [主文档](./module-design-guidelines.mdc) | 核心设计原则、文档概述、七要素框架 |
| 📘 [七要素详细规范](./module-seven-elements.mdc) | 第3-9章：背景、角色、模型、流程、状态、接口、数据 |
| 📙 **当前文档** | 第10-15章：NFR、监控、安全、风险 |
| 📕 [工程实践指南](./module-engineering-practices.mdc) | 第16-24章：技术债、评审、演进、快速指南 |

---

## 10. 非功能性需求 (NFR)

### 10.1 NFR 指标定义
| 类别 | 目标 | 指标细化 | 验证方式 |
| ---- | ---- | -------- | -------- |
| **性能** | p95 < 300ms | 峰值 500 rps | 压测报告 |
| **吞吐** | 每小时 50k 结算 | 并行度 4 | 生产监控 |
| **可用性** | 99.9% | 关键链路降级方案 | SLA 统计 |
| **一致性** | 最终一致 < 2min | Outbox + 补偿任务 | 数据对账 |
| **安全** | 操作审计 | 修改/删除行为记录 | 审计日志 |
| **可扩展性** | 水平扩展 | 无状态设计 | 扩容演练 |

### 10.2 质量维度雷达（示例占比）
```mermaid
pie title 质量维度(占比示意,自行评估)
  "Maintainability" : 20
  "Observability" : 15
  "Performance" : 20
  "Resilience" : 15
  "Security" : 15
  "Scalability" : 15
```
> 实际项目请用度量结果（静态扫描、压测、故障演练）更新占比，低于阈值项需进入技术债表。

### 10.3 性能基线
| 场景 | QPS | P50 | P95 | P99 | 错误率 |
|------|-----|-----|-----|-----|--------|
| 查询接口 | 500 | 20ms | 50ms | 100ms | <0.1% |
| 创建接口 | 100 | 50ms | 100ms | 200ms | <0.5% |
| 批量操作 | 10 | 500ms | 1s | 2s | <1% |

### 10.4 容量规划
| 资源 | 当前容量 | 峰值容量 | 扩容策略 |
|------|----------|----------|----------|
| CPU | 4核 × 3实例 | 4核 × 10实例 | 自动扩容 CPU>70% |
| 内存 | 8GB × 3实例 | 8GB × 10实例 | 自动扩容 Mem>80% |
| 数据库连接池 | 20/实例 | 50/实例 | 动态调整 |
| 消息队列 | 1000/s | 5000/s | 队列分片 |

---

## 11. 错误处理与韧性策略

### 11.1 错误分类
| 错误类型 | 定义 | 处理策略 | 示例 |
|----------|------|----------|------|
| **校验失败** | 输入参数不合法 | 立即返回 400 | 金额为负数 |
| **业务冲突** | 违反业务规则 | 返回 409 | 订单已结算 |
| **下游失败** | 依赖服务故障 | 重试或降级 | 支付服务超时 |
| **并发冲突** | 乐观锁冲突 | 重试或返回 409 | version 不匹配 |
| **系统异常** | 未预期的错误 | 返回 500 + 告警 | NPE、数据库连接失败 |

### 11.2 重试策略
| 场景 | 重试次数 | 退避策略 | 幂等保证 |
|------|----------|----------|----------|
| **HTTP 调用** | 最多 3 次 | 指数退避 + jitter | 幂等键 |
| **消息消费** | 最多 5 次 | 固定间隔 1/5/15/60/300s | 消息ID |
| **数据库操作** | 最多 2 次 | 立即重试 | 乐观锁 version |
| **分布式锁** | 最多 3 次 | 固定间隔 100ms | 锁键 |

### 11.3 降级策略
```mermaid
graph TD
    A[请求到达] --> B{核心功能?}
    B -->|是| C[正常处理]
    B -->|否| D{依赖可用?}
    D -->|是| E[正常调用]
    D -->|否| F[降级处理]
    F --> F1[返回缓存数据]
    F --> F2[返回默认值]
    F --> F3[跳过非核心步骤]
    C --> G[返回结果]
    E --> G
    F1 & F2 & F3 --> G
```

### 11.4 熔断配置
| 参数 | 值 | 说明 |
|------|------|------|
| **失败阈值** | 50% | 50%以上请求失败则熔断 |
| **最小请求数** | 20 | 至少20个请求才统计 |
| **熔断时长** | 30s | 熔断后30秒尝试恢复 |
| **半开状态** | 5个请求 | 半开状态放行5个测试 |

### 11.5 补偿机制
| 场景 | 补偿方式 | 触发条件 | 执行时机 |
|------|----------|----------|----------|
| **订单创建失败** | 释放库存 | 创建超时/失败 | 同步补偿 |
| **支付回调丢失** | 定时查询支付状态 | 15分钟未收到回调 | 异步补偿 |
| **数据不一致** | 对账任务 | 每日凌晨 | 定时补偿 |

---

## 12. 监控与可观测性

### 12.1 指标监控（RED 方法）
> 参考[主文档](./module-design-guidelines.mdc)第0.6节 可观测性设计原则

| 维度 | 指标 | 阈值 | 告警级别 |
|------|------|------|----------|
| **Rate** (速率) | QPS | >1000 | Warning |
| **Errors** (错误率) | Error Rate | >1% | Critical |
| **Duration** (延迟) | P95 Latency | >500ms | Warning |
| | P99 Latency | >1s | Critical |

### 12.2 资源监控（USE 方法）
| 资源类型 | Utilization | Saturation | Errors |
|----------|-------------|------------|--------|
| **CPU** | 平均使用率 | CPU队列长度 | CPU限流次数 |
| **内存** | 堆使用率 | GC 频率 | OOM 次数 |
| **数据库** | 连接池使用率 | 等待队列长度 | 超时/失败次数 |
| **消息队列** | 消费速率 | 队列积压 | 死信数量 |

### 12.3 业务指标
| 指标 | 含义 | 阈值 | 统计周期 |
|------|------|------|----------|
| **结算成功率** | 成功结算订单/总订单 | >99.5% | 小时 |
| **平均结算金额** | 单笔结算平均金额 | 监控异常波动 | 天 |
| **人工介入率** | 需人工处理/总订单 | <0.5% | 天 |
| **对账差异率** | 对账差异笔数/总笔数 | <0.01% | 天 |

### 12.4 日志规范
> 参考[主文档](./module-design-guidelines.mdc)第0.6节 日志分级原则

| 场景 | 日志级别 | 必含字段 | 示例 |
|------|----------|----------|------|
| **请求入口** | INFO | traceId, userId, api, params | `[INFO] [traceId=xxx] POST /settlements` |
| **业务成功** | INFO | traceId, bizKey, result | `[INFO] [traceId=xxx] Settlement created: batchNo=xxx` |
| **业务异常** | WARN | traceId, bizKey, errorCode, reason | `[WARN] [traceId=xxx] Order already settled: orderId=xxx` |
| **系统异常** | ERROR | traceId, exception stack | `[ERROR] [traceId=xxx] DB connection failed: ...` |
| **性能慢查询** | WARN | traceId, duration, sql | `[WARN] [traceId=xxx] Slow query: 2.5s, SELECT ...` |

### 12.5 链路追踪
```mermaid
sequenceDiagram
    participant Gateway
    participant Service
    participant DB
    participant MQ
    Note over Gateway: 生成 traceId
    Gateway->>Service: HTTP (traceId in header)
    Note over Service: span: http.POST.settlements
    Service->>DB: SQL Query
    Note over Service: span: db.query.settlements
    Service->>MQ: Publish Event
    Note over Service: span: mq.publish.settlement.created
    Service-->>Gateway: Response
```

### 12.6 告警配置
| 告警项 | 触发条件 | 告警渠道 | 处理SLA |
|--------|----------|----------|---------|
| **服务不可用** | 连续3次健康检查失败 | 电话 + 短信 | 5分钟 |
| **错误率超标** | 错误率>1% 持续5分钟 | 短信 + IM | 15分钟 |
| **性能劣化** | P95>500ms 持续10分钟 | IM | 30分钟 |
| **业务指标异常** | 成功率<99.5% | IM | 1小时 |

---

## 13. 安全与风险控制

### 13.1 认证与授权
> 参考[主文档](./module-design-guidelines.mdc)第0.7节 安全设计原则

#### 认证机制
| 场景 | 认证方式 | Token 有效期 | 刷新策略 |
|------|----------|-------------|----------|
| **内部服务** | JWT | 24小时 | 自动刷新 |
| **外部API** | API Key + Secret | 永久 | 定期轮换 |
| **管理后台** | OAuth 2.0 | 2小时 | 滑动刷新 |

#### 权限矩阵
| 角色 | 查询 | 创建 | 修改 | 删除 | 审批 |
|------|------|------|------|------|------|
| **运营人员** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **财务人员** | ✅ | ❌ | ❌ | ❌ | ✅ |
| **系统管理员** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **外部系统** | ✅ | ✅ | ❌ | ❌ | ❌ |

### 13.2 数据安全
| 数据类型 | 存储加密 | 传输加密 | 日志脱敏 | 备份策略 |
|----------|----------|----------|----------|----------|
| **用户密码** | BCrypt | HTTPS | ✅ 完全脱敏 | 不备份明文 |
| **手机号** | AES-256 | HTTPS | ✅ 中间4位 | 加密备份 |
| **身份证** | AES-256 | HTTPS | ✅ 中间10位 | 加密备份 |
| **银行卡号** | AES-256 | HTTPS | ✅ 仅显示后4位 | 加密备份 |
| **金额** | 明文 | HTTPS | ❌ 不脱敏 | 加密备份 |

### 13.3 安全威胁防护
> 参考[主文档](./module-design-guidelines.mdc)第0.7节 常见安全威胁与防护

| 威胁 | 防护措施 | 检查点 |
|------|----------|--------|
| **SQL 注入** | PreparedStatement + 参数化查询 | 代码审查 |
| **XSS** | 输出转义 + CSP 策略 | 安全扫描 |
| **CSRF** | Token 验证 + SameSite Cookie | 渗透测试 |
| **越权访问** | 资源级权限校验 | 权限测试 |
| **敏感信息泄露** | 脱敏 + 加密 + HTTPS | 日志审计 |
| **DDoS** | 限流 + WAF | 压测验证 |

### 13.4 审计日志
| 操作类型 | 记录内容 | 保留期限 | 用途 |
|----------|----------|----------|------|
| **登录/登出** | 用户ID、时间、IP、设备 | 1年 | 安全追踪 |
| **权限变更** | 操作人、目标用户、变更前后 | 3年 | 合规审计 |
| **敏感操作** | 操作人、资源ID、操作内容 | 3年 | 合规审计 |
| **数据导出** | 操作人、导出范围、时间 | 3年 | 数据保护 |

### 13.5 限流与防刷
| 维度 | 限流策略 | 阈值 | 响应码 |
|------|----------|------|--------|
| **IP 限流** | 滑动窗口 | 100/min | 429 |
| **用户限流** | 令牌桶 | 50/min | 429 |
| **接口限流** | 漏桶算法 | 根据接口 | 429 |
| **验证码** | 失败3次后要求验证码 | 10分钟有效 | 403 |

---

## 14. 迁移与发布策略

### 14.1 渐进式发布流程
```mermaid
graph LR
    A[双写阶段] --> B[验证阶段]
    B --> C[切换阶段]
    C --> D[清理阶段]
    
    A1[新旧系统同时写入] --> A
    A --> A2[对比数据一致性]
    
    B1[小流量读新系统] --> B
    B --> B2[对比新旧结果]
    
    C1[逐步切换读流量] --> C
    C --> C2[100%切换到新系统]
    
    D1[停止双写] --> D
    D --> D2[下线旧系统]
```

### 14.2 数据迁移策略
| 阶段 | 步骤 | 验证方式 | 回滚条件 |
|------|------|----------|----------|
| **1. 双写** | 新旧系统同时写入 | 数据一致性对比 | 新系统写入失败率>1% |
| **2. 验证** | 10%流量读新系统 | 业务指标对比 | 新系统错误率>旧系统2倍 |
| **3. 切换** | 逐步切到100% | 持续监控 | 业务指标劣化>5% |
| **4. 清理** | 停止双写，下线旧系统 | 数据完整性检查 | 发现数据丢失 |

### 14.3 灰度发布策略
| 阶段 | 流量占比 | 持续时间 | 观察指标 |
|------|----------|----------|----------|
| **Alpha** | 内部用户 | 1天 | 功能完整性 |
| **Beta** | 1% | 1天 | 错误率、性能 |
| **Gamma** | 10% | 2天 | 业务指标 |
| **Production** | 100% | - | 全量监控 |

### 14.4 回滚条件与预案
| 指标 | 正常阈值 | 告警阈值 | 回滚阈值 | 回滚方式 |
|------|----------|----------|----------|----------|
| **错误率** | <0.1% | >0.5% | >1% | 秒级流量切换 |
| **性能劣化** | P95<300ms | P95>500ms | P95>1s | 秒级流量切换 |
| **业务指标** | 成功率>99.5% | 成功率<99% | 成功率<98% | 5分钟内回滚 |
| **数据一致性** | 0差异 | 0.01%差异 | 0.1%差异 | 停止双写，补偿 |

---

## 15. 风险与缓解

### 15.1 技术风险
| 风险 | 影响 | 概率 | 缓解策略 | 监控信号 |
| ---- | ---- | ---- | -------- | ---------- |
| **数据库单点故障** | 服务不可用 | 中 | 主从复制 + 自动切换 | DB 健康检查 |
| **消息队列积压** | 数据延迟 | 高 | 动态扩容消费者 + 限流 | 队列长度 |
| **缓存雪崩** | 性能劣化 | 中 | 缓存预热 + 过期时间随机 | 缓存命中率 |
| **依赖服务故障** | 功能降级 | 高 | 熔断 + 降级 + 重试 | 下游错误率 |
| **内存泄漏** | OOM 崩溃 | 低 | 监控 + 定期重启 | 内存增长趋势 |

### 15.2 业务风险
| 风险 | 影响 | 概率 | 缓解策略 | 监控信号 |
| ---- | ---- | ---- | -------- | ---------- |
| **数据不一致** | 财务差异 | 中 | 对账任务 + 人工核对 | 对账差异数量 |
| **重复结算** | 资损 | 低 | 幂等键 + 状态机 | 重复操作告警 |
| **计算错误** | 结算金额错误 | 低 | 单元测试 + 对账 | 金额异常波动 |
| **恶意刷单** | 资损 | 中 | 风控规则 + 限流 | 异常订单模式 |
| **并发冲突** | 数据覆盖 | 高 | 乐观锁 + 重试 | 冲突次数 |

### 15.3 合规风险
| 风险 | 影响 | 缓解策略 | 验证方式 |
| ---- | ---- | -------- | -------- |
| **数据隐私泄露** | 法律责任 | 加密 + 脱敏 + 权限控制 | 安全审计 |
| **审计日志缺失** | 无法追溯 | 完整审计日志 + 备份 | 日志审查 |
| **敏感操作无授权** | 合规问题 | 二次确认 + 审批流程 | 权限测试 |
| **数据备份失败** | 数据丢失 | 多地域备份 + 定期演练 | 备份验证 |

### 15.4 风险应急预案
```mermaid
graph TD
    A[风险触发] --> B{影响范围?}
    B -->|核心功能| C[P0 级别]
    B -->|重要功能| D[P1 级别]
    B -->|一般功能| E[P2 级别]
    
    C --> C1[立即响应<5min]
    C --> C2[组建战斗室]
    C --> C3[通知CEO/CTO]
    
    D --> D1[15min内响应]
    D --> D2[组建应急小组]
    D --> D3[通知技术负责人]
    
    E --> E1[1h内响应]
    E --> E2[分配处理人]
    E --> E3[通知团队]
```

---

## 下一步

完成质量保障设计后：

1. **工程实践** → 查看[工程实践指南](./module-engineering-practices.mdc)
2. **设计原则回顾** → 返回[主文档](./module-design-guidelines.mdc)
3. **七要素设计** → 返回[七要素详细规范](./module-seven-elements.mdc)

---

## 文档修订历史

- **2025-10-28**：从主文档拆分独立
  - 包含第10-15章：质量保障规范
  - 添加文档导航和跨文档引用
