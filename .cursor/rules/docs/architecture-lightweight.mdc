---
description: 轻量级架构文档模板（适用于中小型项目）
globs: ["**/docs/architecture.md", "**/docs/arch/**"]
alwaysApply: false
---
最近更新: 2025-10-11

# 轻量级架构文档模板

> 适用于中小型项目的精简架构文档模板，30分钟完成基础版，2小时完成完整版。

## 1. 适用场景

### 1.1 项目规模
| 维度 | 范围 | 说明 |
|------|------|------|
| **团队规模** | ≤ 10人 | 单团队或小型协作团队 |
| **开发周期** | ≤ 6个月 | MVP 或阶段性交付 |
| **服务数量** | ≤ 5个 | 单体应用或简单微服务 |
| **数据源** | ≤ 3个 | 主库 + 缓存 + 消息队列 |
| **外部依赖** | ≤ 8个 | 第三方服务和内部服务 |

### 1.2 何时使用
**✅ 适合使用**：
- 快速启动的新项目
- 需要快速对齐技术方案
- 团队规模较小，沟通成本低
- 迭代速度快，文档需要灵活

**❌ 不适合使用**：
- 大型分布式系统（使用完整架构文档）
- 多团队协作项目（需要更详细的接口定义）
- 高合规要求项目（需要完整的文档体系）

### 1.3 升级到完整版的时机
出现以下情况建议升级：
- 团队规模 > 10人
- 服务数量 > 5个
- 外部依赖 > 8个
- 需要详细的组件设计和方法签名
- 跨团队协作频繁

参考：`module-design-guidelines.mdc`（完整版模板）

## 2. 快速填写指南

### 2.1 30分钟快速版
**适用场景**：项目启动初期，快速对齐基本方案

**必填章节**：
1. ✅ 系统概述（10分钟）
2. ✅ 整体架构（10分钟）
3. ✅ 核心流程（10分钟）

**输出**：PPT 级别的架构说明，支持团队讨论

### 2.2 2小时标准版
**适用场景**：开发启动前，需要指导实施

**必填章节**：
1. ✅ 系统概述
2. ✅ 整体架构
3. ✅ 核心流程
4. ✅ 数据设计
5. ✅ 接口设计
6. ✅ 技术选型
7. ✅ 非功能需求

**输出**：实施级文档，支持开发和测试

### 2.3 1天完整版
**适用场景**：评审前或交付时

**全部章节**：标准版 + 部署架构 + 风险对策 + 后续规划

**输出**：评审级文档，支持技术评审和决策

## 3. 文档模板

### 3.1 文档头部
```markdown
# <系统名称> 架构说明

**项目类型**: Web应用 / 移动应用 / 微服务 / 数据平台  
**文档版本**: v1.0  
**文档状态**: 草稿 / 评审中 / 已批准  
**负责人**: 姓名  
**创建日期**: YYYY-MM-DD  
**最后更新**: YYYY-MM-DD  

## 变更记录
| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | YYYY-MM-DD | 初始版本 | 姓名 |
```

### 3.2 章节结构

---

## ① 系统概述

### 1.1 业务目标
**问题描述**：
- 解决什么业务痛点？
- 目标用户是谁？
- 核心价值是什么？

**量化目标**：
- 用户规模：预计日活 / 月活
- 性能要求：TPS / QPS / 响应时间
- 业务指标：转化率 / 交易量等

**示例**：
```markdown
### 1.1 业务目标
**问题描述**：
当前订单处理系统响应慢（平均 5秒），影响用户体验，导致订单转化率下降 15%。

**量化目标**：
- 支持 1000 QPS 订单查询
- 订单处理响应时间 < 500ms
- 系统可用性 99.9%
- 日订单量支持 10万单
```

### 1.2 用户与场景
| 用户角色 | 核心场景 | 使用频率 | 重要性 |
|---------|---------|---------|--------|
| 普通用户 | 浏览商品、下单 | 高频 | P0 |
| 商家 | 管理商品、处理订单 | 中频 | P0 |
| 运营 | 数据分析、活动配置 | 低频 | P1 |
| 管理员 | 系统配置、权限管理 | 低频 | P1 |

### 1.3 核心功能
**P0（核心必需）**：
- 用户注册登录
- 商品浏览和搜索
- 订单下单和支付
- 订单状态查询

**P1（重要）**：
- 购物车管理
- 收藏和历史记录
- 优惠券和促销
- 订单评价

**P2（增强）**：
- 积分系统
- 推荐系统
- 数据分析

### 1.4 技术栈
| 层次 | 技术选型 | 版本 | 选择理由 |
|------|----------|------|----------|
| **前端** | Vue 3 + TypeScript | 3.4+ | 团队熟悉，生态成熟 |
| **后端** | Spring Boot | 3.2+ | 快速开发，社区活跃 |
| **数据库** | MySQL | 8.0+ | 关系型需求，运维成熟 |
| **缓存** | Redis | 7.0+ | 高性能，支持多种数据结构 |
| **消息队列** | RabbitMQ | 3.12+ | 可靠性高，功能完善 |
| **搜索** | Elasticsearch | 8.x | 全文检索需求 |

---

## ② 整体架构

### 2.1 系统边界
```mermaid
flowchart TB
    subgraph 外部系统
        A[移动App]
        B[Web前端]
        C[第三方支付]
        D[物流系统]
    end
    
    subgraph 本系统
        E[API网关]
        F[用户服务]
        G[商品服务]
        H[订单服务]
        I[支付服务]
    end
    
    subgraph 基础设施
        J[(MySQL)]
        K[(Redis)]
        L[RabbitMQ]
    end
    
    A --> E
    B --> E
    E --> F
    E --> G
    E --> H
    E --> I
    I --> C
    H --> D
    F --> J
    G --> J
    H --> J
    F --> K
    G --> K
    H --> L
    
    style E fill:#0ea5e9,stroke:#0369a1,color:#fff
    style 本系统 fill:#f0f9ff,stroke:#0369a1
```

**边界说明**：
- **包含**：用户、商品、订单、支付核心模块
- **不包含**：物流跟踪（依赖第三方）、客服系统（独立系统）
- **上游依赖**：移动App、Web前端
- **下游依赖**：支付网关、物流API、短信服务

### 2.2 架构分层
```mermaid
flowchart TB
    subgraph 接入层
        A1[Nginx] --> A2[API Gateway]
    end
    
    subgraph 应用层
        B1[用户服务]
        B2[商品服务]
        B3[订单服务]
        B4[支付服务]
    end
    
    subgraph 数据层
        C1[(主数据库)]
        C2[(从数据库)]
        C3[(Redis)]
        C4[消息队列]
    end
    
    A2 --> B1
    A2 --> B2
    A2 --> B3
    A2 --> B4
    B1 --> C1
    B2 --> C1
    B3 --> C1
    B4 --> C1
    C1 --> C2
    B1 --> C3
    B2 --> C3
    B3 --> C4
    
    style 接入层 fill:#fef3c7,stroke:#f59e0b
    style 应用层 fill:#dbeafe,stroke:#3b82f6
    style 数据层 fill:#dcfce7,stroke:#22c55e
```

### 2.3 模块划分
| 模块 | 职责 | 主要功能 | 依赖 |
|------|------|----------|------|
| **用户服务** | 用户管理 | 注册、登录、权限 | MySQL、Redis |
| **商品服务** | 商品管理 | 商品CRUD、库存 | MySQL、Redis、ES |
| **订单服务** | 订单处理 | 下单、支付、状态 | MySQL、Redis、MQ |
| **支付服务** | 支付集成 | 支付、退款 | MySQL、第三方支付 |

---

## ③ 核心流程

### 3.1 用例列表
| 用例 | 描述 | 频率 | 性能要求 | 重要性 |
|------|------|------|----------|--------|
| 用户下单 | 选择商品、创建订单 | 高 | <500ms | P0 |
| 订单支付 | 调用支付、更新状态 | 高 | <1s | P0 |
| 商品搜索 | 关键词搜索商品 | 极高 | <200ms | P0 |
| 订单查询 | 查看订单详情 | 高 | <300ms | P0 |
| 库存扣减 | 下单时扣减库存 | 高 | <100ms | P0 |

### 3.2 主流程时序图
**用例：用户下单购买**

```mermaid
sequenceDiagram
    actor 用户
    participant App as 移动App
    participant Gateway as API网关
    participant Order as 订单服务
    participant Product as 商品服务
    participant Payment as 支付服务
    participant DB as 数据库
    participant MQ as 消息队列
    
    用户->>App: 1. 点击下单
    App->>Gateway: 2. POST /orders
    Gateway->>Order: 3. 创建订单
    
    Order->>Product: 4. 检查库存
    Product->>DB: 5. 查询库存
    DB-->>Product: 6. 返回库存
    Product-->>Order: 7. 库存充足
    
    Order->>DB: 8. 创建订单记录
    Order->>Product: 9. 锁定库存
    Product->>DB: 10. 扣减库存
    
    Order->>MQ: 11. 发送订单创建事件
    Order-->>Gateway: 12. 返回订单号
    Gateway-->>App: 13. 显示订单详情
    App-->>用户: 14. 跳转支付页面
    
    用户->>App: 15. 确认支付
    App->>Payment: 16. 调用支付
    Payment->>第三方: 17. 发起支付
    第三方-->>Payment: 18. 支付成功
    Payment->>Order: 19. 更新订单状态
    Payment->>MQ: 20. 发送支付成功事件
    Payment-->>App: 21. 支付成功
    App-->>用户: 22. 显示支付结果
    
    Note over Order,MQ: 异步处理：发货、积分、通知等
```

### 3.3 异常流程
```mermaid
flowchart TD
    A[开始下单] --> B{库存检查}
    B -->|库存不足| C[返回库存不足]
    B -->|库存充足| D[创建订单]
    D --> E{订单创建}
    E -->|失败| F[返回创建失败]
    E -->|成功| G[锁定库存]
    G --> H{支付}
    H -->|超时/失败| I[释放库存]
    H -->|成功| J[扣减库存]
    I --> K[订单关闭]
    J --> L[订单完成]
    
    style C fill:#fca5a5,stroke:#dc2626,color:#fff
    style F fill:#fca5a5,stroke:#dc2626,color:#fff
    style I fill:#fcd34d,stroke:#f59e0b
    style L fill:#86efac,stroke:#22c55e
```

**关键异常处理**：
- **库存不足**：实时返回，提示用户
- **支付超时**：15分钟后自动取消，释放库存
- **重复下单**：订单号去重，防止重复扣库存
- **并发冲突**：乐观锁 + 重试机制

---

## ④ 数据设计

### 4.1 核心实体
```mermaid
erDiagram
    USER ||--o{ ORDER : places
    USER {
        bigint id PK
        string username
        string email
        string phone
        string password_hash
        datetime created_at
    }
    
    ORDER ||--|{ ORDER_ITEM : contains
    ORDER {
        bigint id PK
        bigint user_id FK
        string order_no UK
        decimal total_amount
        string status
        datetime created_at
        datetime paid_at
    }
    
    ORDER_ITEM }o--|| PRODUCT : references
    ORDER_ITEM {
        bigint id PK
        bigint order_id FK
        bigint product_id FK
        int quantity
        decimal price
    }
    
    PRODUCT {
        bigint id PK
        string name
        string description
        decimal price
        int stock
        string status
        datetime created_at
    }
```

### 4.2 数据字典
**用户表（user）**：
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| username | VARCHAR(50) | 用户名 | UNIQUE, NOT NULL |
| email | VARCHAR(100) | 邮箱 | UNIQUE, NOT NULL |
| phone | VARCHAR(20) | 手机号 | UNIQUE |
| password_hash | VARCHAR(255) | 密码哈希 | NOT NULL |
| status | TINYINT | 状态：0禁用 1正常 | NOT NULL, DEFAULT 1 |
| created_at | DATETIME | 创建时间 | NOT NULL |

**订单表（order）**：
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| order_no | VARCHAR(32) | 订单号 | UNIQUE, NOT NULL |
| user_id | BIGINT | 用户ID | FK, INDEX, NOT NULL |
| total_amount | DECIMAL(10,2) | 订单金额 | NOT NULL |
| status | VARCHAR(20) | 状态：PENDING/PAID/SHIPPED/COMPLETED/CANCELLED | NOT NULL |
| created_at | DATETIME | 创建时间 | NOT NULL |
| paid_at | DATETIME | 支付时间 | NULL |

### 4.3 索引设计
| 表 | 索引名 | 字段 | 类型 | 说明 |
|------|--------|------|------|------|
| user | idx_email | email | UNIQUE | 邮箱登录 |
| user | idx_phone | phone | UNIQUE | 手机号登录 |
| order | idx_user_id | user_id | INDEX | 用户订单查询 |
| order | idx_created_at | created_at | INDEX | 时间范围查询 |
| order | idx_status_created | status, created_at | INDEX | 状态+时间查询 |
| order_item | idx_order_id | order_id | INDEX | 订单明细查询 |

---

## ⑤ 接口设计

### 5.1 RESTful API
| 接口路径 | 方法 | 描述 | 请求参数 | 响应 |
|---------|------|------|----------|------|
| /api/v1/users | POST | 用户注册 | `{username, email, password}` | `{userId, token}` |
| /api/v1/users/login | POST | 用户登录 | `{email, password}` | `{userId, token}` |
| /api/v1/products | GET | 商品列表 | `?page=1&size=20&keyword=` | `{items[], total}` |
| /api/v1/products/{id} | GET | 商品详情 | - | `{id, name, price, stock}` |
| /api/v1/orders | POST | 创建订单 | `{items[], addressId}` | `{orderId, orderNo}` |
| /api/v1/orders/{id} | GET | 订单详情 | - | `{id, orderNo, status, items[]}` |
| /api/v1/orders/{id}/pay | POST | 订单支付 | `{paymentMethod}` | `{payUrl}` |

### 5.2 统一响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {
    // 业务数据
  },
  "traceId": "abc123",
  "timestamp": "2025-10-11T10:30:00Z"
}
```

### 5.3 错误码设计
| 错误码 | 说明 | HTTP状态码 |
|--------|------|------------|
| 200 | 成功 | 200 |
| 400 | 参数错误 | 400 |
| 401 | 未授权 | 401 |
| 403 | 无权限 | 403 |
| 404 | 资源不存在 | 404 |
| 409 | 资源冲突（如库存不足） | 409 |
| 500 | 服务器错误 | 500 |
| 1001 | 用户不存在 | 400 |
| 1002 | 密码错误 | 400 |
| 2001 | 商品不存在 | 404 |
| 2002 | 库存不足 | 409 |
| 3001 | 订单不存在 | 404 |
| 3002 | 订单状态错误 | 400 |

---

## ⑥ 技术选型

### 6.1 选型对比
| 技术类别 | 方案A | 方案B | 最终选择 | 理由 |
|---------|-------|-------|----------|------|
| **后端框架** | Spring Boot | Node.js | Spring Boot | 团队熟悉，生态成熟 |
| **数据库** | MySQL | PostgreSQL | MySQL | 运维经验丰富 |
| **缓存** | Redis | Memcached | Redis | 功能更丰富 |
| **消息队列** | RabbitMQ | Kafka | RabbitMQ | 场景匹配，易用 |

### 6.2 关键决策
**决策 1：为什么选择单体架构？**
- 团队规模小（5人），微服务管理成本高
- 业务复杂度低，模块间耦合可控
- 初期流量小，单体足够支撑
- 后期可按模块拆分为微服务

**决策 2：为什么选择 MySQL 而不是 MongoDB？**
- 订单数据关系复杂，适合关系型数据库
- 需要事务支持，保证数据一致性
- 团队对 MySQL 更熟悉

**决策 3：为什么使用 Redis 作为缓存？**
- 支持多种数据结构（String、Hash、List、Set）
- 性能高，支持持久化
- 社区活跃，运维工具丰富

相关 ADR：参考 `adr-template.mdc`

---

## ⑦ 部署架构

### 7.1 环境规划
| 环境 | 用途 | 配置 | 域名 |
|------|------|------|------|
| **开发环境** | 本地开发 | 1C2G | localhost |
| **测试环境** | 集成测试 | 2C4G | test.example.com |
| **预发布环境** | 预发布验证 | 4C8G | staging.example.com |
| **生产环境** | 正式服务 | 4C8G × 2 | www.example.com |

### 7.2 部署拓扑
```mermaid
flowchart TB
    subgraph 用户端
        A1[移动App]
        A2[Web浏览器]
    end
    
    subgraph 负载均衡
        B[Nginx]
    end
    
    subgraph 应用层
        C1[应用实例1<br/>4C8G]
        C2[应用实例2<br/>4C8G]
    end
    
    subgraph 数据层
        D1[(MySQL主库<br/>4C16G)]
        D2[(MySQL从库<br/>4C16G)]
        E1[Redis主<br/>2C4G]
        E2[Redis从<br/>2C4G]
        F[RabbitMQ<br/>2C4G]
    end
    
    A1 --> B
    A2 --> B
    B --> C1
    B --> C2
    C1 --> D1
    C2 --> D1
    D1 -.->|同步| D2
    C1 --> E1
    C2 --> E1
    E1 -.->|同步| E2
    C1 --> F
    C2 --> F
    
    style B fill:#fbbf24,stroke:#f59e0b,color:#fff
    style C1 fill:#60a5fa,stroke:#3b82f6,color:#fff
    style C2 fill:#60a5fa,stroke:#3b82f6,color:#fff
    style D1 fill:#34d399,stroke:#10b981,color:#fff
    style D2 fill:#34d399,stroke:#10b981,color:#fff
```

### 7.3 监控和日志
**监控方案**：
- **应用监控**：Prometheus + Grafana
- **日志收集**：ELK（Elasticsearch + Logstash + Kibana）
- **链路追踪**：Zipkin / Jaeger
- **告警**：钉钉机器人 / 邮件

**健康检查**：
- `/health` - 应用健康状态
- `/metrics` - Prometheus 指标
- `/info` - 应用版本信息

---

## ⑧ 非功能需求（NFR）

### 8.1 性能指标
| 指标 | 目标 | 度量方式 | 当前值 |
|------|------|----------|--------|
| **响应时间** | P95 < 500ms | APM 监控 | - |
| **吞吐量** | 1000 QPS | 压力测试 | - |
| **并发用户** | 5000 在线用户 | 性能测试 | - |
| **数据库查询** | 平均 < 50ms | 慢查询日志 | - |

### 8.2 可用性
| 指标 | 目标 | 保障措施 |
|------|------|----------|
| **系统可用性** | 99.9% | 主从热备、健康检查、自动重启 |
| **数据可靠性** | 99.99% | 数据库主从复制、定时备份 |
| **故障恢复** | < 5分钟 | 自动切换、告警通知 |

### 8.3 安全性
| 维度 | 措施 | 说明 |
|------|------|------|
| **身份认证** | JWT Token | 有效期 2小时，支持刷新 |
| **数据加密** | HTTPS + 数据库字段加密 | 敏感字段加密存储 |
| **SQL 注入** | 参数化查询 | 使用 ORM 框架 |
| **XSS 防护** | 输入过滤 + 输出编码 | 前后端双重防护 |
| **权限控制** | RBAC | 基于角色的访问控制 |

### 8.4 可扩展性
- **水平扩展**：应用无状态，支持多实例部署
- **数据库扩展**：读写分离，未来可分库分表
- **缓存扩展**：Redis 集群，支持横向扩展
- **消息队列**：支持多消费者，并行处理

---

## ⑨ 风险与对策

### 9.1 技术风险
| 风险 | 影响 | 概率 | 缓解措施 | 负责人 |
|------|------|------|----------|--------|
| 数据库单点故障 | 服务完全不可用 | 低 | 主从复制 + 自动切换 | DBA |
| Redis 缓存失效 | 性能下降 | 中 | 缓存预热 + 限流保护 | 后端负责人 |
| 第三方支付故障 | 支付功能不可用 | 中 | 降级处理 + 重试机制 | 后端负责人 |
| 库存超卖 | 数据不一致 | 中 | 分布式锁 + 数据库行锁 | 后端负责人 |
| 消息积压 | 处理延迟 | 低 | 监控告警 + 动态扩容 | 运维负责人 |

### 9.2 业务风险
| 风险 | 影响 | 对策 |
|------|------|------|
| 流量激增 | 系统过载 | 限流 + 降级 + 弹性扩容 |
| 恶意攻击 | 服务中断 | WAF + 限流 + IP 黑名单 |
| 数据泄露 | 信息安全 | 数据加密 + 审计日志 + 权限控制 |

### 9.3 监控告警
**关键指标监控**：
- CPU使用率 > 80%
- 内存使用率 > 85%
- 接口错误率 > 1%
- 接口响应时间 P95 > 1s
- 数据库连接数 > 80%

**告警策略**：
- P0 告警：电话 + 短信
- P1 告警：钉钉机器人
- P2 告警：邮件

---

## ⑩ 后续规划

### 10.1 短期目标（1-3个月）
- [x] 完成核心功能开发
- [ ] 完成性能测试和优化
- [ ] 建立监控告警体系
- [ ] 完成安全加固

### 10.2 中期目标（3-6个月）
- [ ] 支持 5000 并发用户
- [ ] 优化搜索性能
- [ ] 完善推荐系统
- [ ] 移动端优化

### 10.3 长期目标（6个月以上）
- [ ] 微服务拆分（按需）
- [ ] 数据分库分表
- [ ] 多地域部署
- [ ] AI 推荐引擎

### 10.4 技术债务
| 债务项 | 影响 | 优先级 | 计划时间 |
|--------|------|--------|----------|
| 缺少自动化测试 | 回归测试成本高 | P1 | Q2 |
| 日志结构化不完整 | 问题排查困难 | P2 | Q2 |
| 缓存策略需优化 | 缓存命中率低 | P2 | Q3 |
| 数据库慢查询优化 | 响应时间偏高 | P1 | Q2 |

---

## 11. 文档维护

### 11.1 更新频率
- **重大变更**：架构调整、技术栈变更时必须更新
- **定期回顾**：每季度回顾一次，更新现状
- **版本发布**：每次大版本发布后更新

### 11.2 评审流程
1. 初稿完成后，团队内部评审
2. 技术负责人审核
3. 相关利益方确认
4. 状态改为"已批准"

### 11.3 文档存放
```
项目根目录/
├── docs/
│   ├── architecture.md  # 架构文档（本文档）
│   ├── adr/  # 架构决策记录
│   └── api/  # API 文档
```

---

## 12. 检查清单

### 12.1 完整性检查
- [ ] 业务目标清晰，有量化指标
- [ ] 架构图完整，边界明确
- [ ] 核心流程有时序图和异常处理
- [ ] 数据模型完整，索引合理
- [ ] API 接口定义清晰
- [ ] 技术选型有理由说明
- [ ] 非功能需求量化
- [ ] 风险识别充分，有缓解措施
- [ ] 后续规划明确

### 12.2 质量检查
- [ ] 图表清晰，标注完整
- [ ] 表格信息完整，无遗漏
- [ ] 代码示例准确
- [ ] 术语统一，无歧义
- [ ] 格式规范，易读性好

### 12.3 可行性检查
- [ ] 技术方案可实施
- [ ] 资源投入合理
- [ ] 时间计划可行
- [ ] 风险可控

---

## 13. 快速示例

参考上述章节的示例内容，它们展示了如何填写每个部分。

关键提示：
- ✅ 使用具体数字，避免"高性能"、"很快"等模糊词
- ✅ 使用图表辅助说明，提高可读性
- ✅ 说明"为什么"，不仅是"是什么"
- ✅ 考虑异常情况，不只是成功路径

---

## 14. 与其他规约的关系

- **完整版架构**: 升级参考 `module-design-guidelines.mdc`
- **架构决策**: 关键决策记录到 `adr-template.mdc`
- **功能规格**: 详细功能说明参考 `feature-specification-guidelines.mdc`
- **文档规范**: 遵循 `document.mdc` 的通用要求
- **代码规范**: 实施时遵循 `coding-standards.mdc`

---

**重要提示**：架构文档是活文档，应随系统演进持续更新，不要让它变成过时的"遗产"！
