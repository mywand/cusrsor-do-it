---
description: 架构决策记录模板（Architecture Decision Record）
globs: ["**/docs/adr/**", "**/ADR-*.md"]
alwaysApply: false
---
最近更新: 2025-10-11

# 架构决策记录（ADR）模板

> 用于记录重要架构决策的标准化模板，确保决策过程透明、可追溯、可审查。

## 1. 什么是 ADR

### 1.1 定义
架构决策记录（Architecture Decision Record，ADR）是一种轻量级文档，用于记录在软件开发过程中做出的重要架构决策。

### 1.2 价值
- **透明性**：决策过程和理由公开透明
- **可追溯**：未来可以回顾为什么做出某个决策
- **知识传承**：新成员可以快速了解系统演进历史
- **避免重复讨论**：已讨论过的问题有明确记录

### 1.3 适用场景
以下情况建议创建 ADR：
- 技术栈选择（框架、数据库、中间件）
- 架构模式选择（微服务、分层、事件驱动）
- 重要的性能、安全或可扩展性决策
- 影响成本的技术决策
- 跨团队协作的技术约定

## 2. ADR 文件管理

### 2.1 文件命名
```
ADR-<序号>-<决策主题>.md

示例：
ADR-001-选择-PostgreSQL-作为主数据库.md
ADR-002-采用-事件驱动架构.md
ADR-003-使用-Redis-作为分布式缓存.md
```

**命名规则**：
- 序号：4位数字，从 0001 开始递增
- 主题：使用中文或英文，简洁明了
- 格式：Markdown (.md)

### 2.2 文件存放
```
项目根目录/
├── docs/
│   ├── adr/
│   │   ├── ADR-0001-选择-PostgreSQL-作为主数据库.md
│   │   ├── ADR-0002-采用-事件驱动架构.md
│   │   ├── ADR-0003-使用-Redis-作为分布式缓存.md
│   │   └── README.md  # ADR 索引文件
```

### 2.3 状态管理
| 状态 | 说明 | 操作 |
|------|------|------|
| **提议中（Proposed）** | 待讨论和决策 | 创建 ADR 草稿，征求意见 |
| **已接受（Accepted）** | 决策已通过，开始实施 | 更新状态，开始实施 |
| **已废弃（Deprecated）** | 不再推荐，但仍在使用 | 说明替代方案 |
| **已取代（Superseded）** | 被新决策替代 | 引用新的 ADR |
| **已拒绝（Rejected）** | 决策未通过 | 说明拒绝理由 |

## 3. ADR 模板

### 3.1 基础模板

```markdown
# ADR-<序号>: <决策标题>

**状态**: 提议中 | 已接受 | 已废弃 | 已取代 | 已拒绝  
**日期**: YYYY-MM-DD  
**决策者**: 姓名或团队  
**利益相关方**: 相关团队或人员  

## 背景与问题（Context）

### 问题描述
清楚描述需要决策的问题或挑战。

**当前现状**：
- 现有方案的不足
- 面临的痛点和瓶颈
- 业务或技术背景

**触发因素**：
- 为什么现在需要做这个决策？
- 什么事件或需求促成了这次讨论？

### 约束条件
- 技术约束（如现有技术栈、团队技能）
- 时间约束（如上线时间要求）
- 预算约束（如许可证费用、资源成本）
- 合规要求（如安全标准、行业规范）

## 决策驱动因素（Decision Drivers）

按重要性排序的决策考虑因素：

1. **[因素名称]** - 描述为什么这个因素重要
2. **[因素名称]** - 说明影响程度
3. **[因素名称]** - ...

示例：
1. **性能要求** - 需要支持 10000 QPS，响应时间 < 100ms
2. **开发效率** - 团队需要在 2 个月内完成开发
3. **运维成本** - 控制在现有预算的 20% 以内

## 候选方案（Considered Options）

### 方案 A：[方案名称]

**描述**：
简要描述方案的核心思路。

**优点**：
- ✅ 优点 1
- ✅ 优点 2
- ✅ 优点 3

**缺点**：
- ❌ 缺点 1
- ❌ 缺点 2
- ❌ 缺点 3

**成本评估**：
- 开发成本：X 人月
- 运维成本：Y 元/月
- 学习成本：Z 天

### 方案 B：[方案名称]

**描述**：
...

**优点**：
- ✅ ...

**缺点**：
- ❌ ...

**成本评估**：
- ...

### 方案 C：[方案名称]

（可选，根据实际情况添加）

## 方案对比

| 维度 | 方案 A | 方案 B | 方案 C |
|------|--------|--------|--------|
| **性能** | 高 | 中 | 低 |
| **开发成本** | 低 | 中 | 高 |
| **运维成本** | 中 | 低 | 高 |
| **学习曲线** | 平缓 | 陡峭 | 平缓 |
| **社区支持** | 活跃 | 一般 | 活跃 |
| **可扩展性** | 好 | 一般 | 很好 |
| **风险** | 低 | 中 | 高 |

## 决策结果（Decision Outcome）

**选择方案**：方案 [A/B/C]

**核心理由**：
1. 理由 1 - 为什么这个方案最合适
2. 理由 2 - 如何平衡各种因素
3. 理由 3 - 权衡后的最优选择

**关键权衡**：
- 牺牲了 [某个方面]，获得了 [更重要的收益]
- 接受了 [某个风险]，因为 [风险可控且收益明显]

## 实施计划（Implementation）

### 实施阶段
| 阶段 | 任务 | 负责人 | 时间 |
|------|------|--------|------|
| 1. 技术验证 | POC 开发 | 张三 | Week 1-2 |
| 2. 基础搭建 | 环境准备 | 李四 | Week 3-4 |
| 3. 核心开发 | 功能实现 | 团队 | Week 5-8 |
| 4. 测试部署 | 测试上线 | 王五 | Week 9-10 |

### 验证标准
- [ ] POC 验证通过，满足性能要求
- [ ] 开发文档完成，团队培训完成
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过，性能测试达标

## 影响分析（Consequences）

### 正面影响
- ✅ 提升性能，满足业务增长需求
- ✅ 降低维护成本
- ✅ 改善开发体验

### 负面影响
- ⚠️ 短期内增加学习成本
- ⚠️ 需要迁移现有数据
- ⚠️ 可能影响现有服务稳定性

### 风险与缓解
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 性能不达预期 | 高 | 中 | POC 验证，性能测试 |
| 团队学习成本高 | 中 | 高 | 提前培训，文档支持 |
| 兼容性问题 | 中 | 低 | 充分测试，灰度发布 |

## 后续行动（Follow-up）

### 短期（1-3个月）
- [ ] 完成技术方案设计
- [ ] 完成 POC 验证
- [ ] 完成团队培训

### 中期（3-6个月）
- [ ] 完成核心功能开发
- [ ] 完成性能测试和优化
- [ ] 完成灰度发布

### 长期（6个月以上）
- [ ] 全量上线
- [ ] 监控指标达标
- [ ] 文档和最佳实践沉淀

## 相关资源（References）

### 相关 ADR
- [ADR-XXX: 相关决策标题](./ADR-XXX-相关决策.md)

### 技术文档
- [官方文档](https://example.com/docs)
- [最佳实践](https://example.com/best-practices)

### 讨论记录
- [会议纪要](link-to-meeting-notes)
- [技术评审](link-to-tech-review)

---

**更新记录**：
- YYYY-MM-DD: 初始版本（提议中）
- YYYY-MM-DD: 更新状态为已接受
- YYYY-MM-DD: 补充实施进展
```

### 3.2 简化模板（适合小型决策）

```markdown
# ADR-<序号>: <决策标题>

**状态**: 已接受  
**日期**: YYYY-MM-DD  

## 问题
简要描述需要决策的问题。

## 决策
我们决定选择 [方案名称]。

## 理由
1. 理由 1
2. 理由 2
3. 理由 3

## 影响
- 正面：...
- 负面：...

## 相关链接
- [相关文档](link)
```

## 4. ADR 编写最佳实践

### 4.1 编写原则
- **简洁明了**：避免冗长，直击要点
- **客观中立**：陈述事实，避免主观臆断
- **可追溯**：引用数据、测试结果、讨论记录
- **面向未来**：考虑 6 个月后的新成员能否理解

### 4.2 常见误区
| 误区 | 问题 | 正确做法 |
|------|------|----------|
| ❌ 只写结论 | 缺少决策过程 | 记录完整的决策推理 |
| ❌ 过于技术化 | 非技术人员难以理解 | 平衡技术深度和可读性 |
| ❌ 缺少替代方案 | 决策不够充分 | 至少列出 2-3 个候选方案 |
| ❌ 忽略负面影响 | 风险未充分评估 | 诚实记录所有影响 |
| ❌ 没有后续跟踪 | 决策无法验证 | 设置验证标准和时间点 |

### 4.3 质量检查清单
- [ ] 问题描述清晰，有量化指标
- [ ] 至少列出 2 个候选方案
- [ ] 每个方案都有优缺点分析
- [ ] 决策理由充分，有数据支持
- [ ] 影响分析全面（正面+负面）
- [ ] 实施计划明确，责任人清晰
- [ ] 风险识别充分，有缓解措施
- [ ] 相关资源链接完整

## 5. ADR 索引管理

### 5.1 ADR 索引文件示例

在 `docs/adr/README.md` 中维护所有 ADR 的索引：

```markdown
# 架构决策记录索引

## 进行中的决策
- [ADR-0005: 选择微服务网关方案](./ADR-0005-选择微服务网关方案.md) - 提议中

## 已接受的决策
- [ADR-0001: 选择 PostgreSQL 作为主数据库](./ADR-0001-选择-PostgreSQL-作为主数据库.md) - 2024-01
- [ADR-0002: 采用事件驱动架构](./ADR-0002-采用-事件驱动架构.md) - 2024-03
- [ADR-0003: 使用 Redis 作为分布式缓存](./ADR-0003-使用-Redis-作为分布式缓存.md) - 2024-05

## 已废弃的决策
- [ADR-0004: 使用 MongoDB](./ADR-0004-使用-MongoDB.md) - 已被 ADR-0001 取代

## 已拒绝的决策
- 无

## 决策统计
- 总决策数：5
- 已接受：3
- 提议中：1
- 已废弃：1
- 已拒绝：0
```

### 5.2 自动化工具
建议使用工具辅助 ADR 管理：
- **adr-tools**: 命令行工具，快速创建和管理 ADR
- **log4brains**: Web UI 工具，可视化 ADR 管理
- **自定义脚本**: 根据团队需求定制

## 6. ADR 与其他文档的关系

```mermaid
graph TB
    A[ADR - 架构决策记录] --> B[架构文档]
    A --> C[设计文档]
    A --> D[技术债务]
    B --> E[系统架构图]
    C --> F[模块设计]
    D --> G[改进计划]
    
    style A fill:#0ea5e9,stroke:#0369a1,color:#fff
```

| 文档类型 | 与 ADR 关系 | 说明 |
|---------|------------|------|
| **架构文档** | 引用 ADR | 架构文档引用相关 ADR 说明架构选择 |
| **设计文档** | 参考 ADR | 设计需遵循 ADR 中的架构决策 |
| **技术债务** | 来源于 ADR | ADR 中识别的风险可能转化为技术债 |
| **版本发布说明** | 关联 ADR | 重大变更需引用对应 ADR |

## 7. 团队协作流程

### 7.1 决策流程
```mermaid
flowchart LR
    A[发现问题] --> B[创建 ADR 草稿]
    B --> C[团队讨论]
    C --> D{达成共识?}
    D -->|是| E[状态改为已接受]
    D -->|否| F[继续讨论/调研]
    F --> C
    E --> G[开始实施]
    G --> H[跟踪验证]
```

### 7.2 评审建议
- **评审人员**：架构师、技术负责人、相关开发人员
- **评审时间**：草稿完成后 1-2 个工作日内
- **评审方式**：会议讨论 + 异步评论
- **通过标准**：多数人同意，无重大异议

### 7.3 维护建议
- **定期回顾**：每季度回顾 ADR，更新状态
- **验证决策**：检查决策结果是否符合预期
- **经验总结**：将经验教训更新到 ADR 中

## 8. 实际案例示例

### 8.1 技术栈选择案例
```markdown
# ADR-0001: 选择 PostgreSQL 作为主数据库

**状态**: 已接受  
**日期**: 2024-01-15  
**决策者**: 技术团队  

## 背景
项目需要选择关系型数据库，当前有 MySQL、PostgreSQL、Oracle 三个候选。

## 决策驱动因素
1. 成本：开源优先，避免高额许可费用
2. 功能：需要支持 JSON、全文检索、GIS
3. 性能：需要支持高并发写入
4. 团队技能：团队对 PostgreSQL 有经验

## 候选方案

### 方案 A：PostgreSQL
**优点**：
- ✅ 开源免费，社区活跃
- ✅ 功能强大，支持 JSON、全文检索、GIS
- ✅ ACID 完整性好
- ✅ 团队有使用经验

**缺点**：
- ❌ 集群方案不如 MySQL 成熟
- ❌ 监控工具相对较少

### 方案 B：MySQL
**优点**：
- ✅ 开源免费，生态成熟
- ✅ 集群方案成熟（如 MHA、MGR）
- ✅ 监控工具丰富

**缺点**：
- ❌ JSON、GIS 功能较弱
- ❌ 复杂查询性能不如 PostgreSQL

### 方案 C：Oracle
**优点**：
- ✅ 功能最强大
- ✅ 企业级支持

**缺点**：
- ❌ 许可费用高昂（约 50 万/年）
- ❌ 对云原生支持不友好

## 决策结果
选择 **PostgreSQL**。

**理由**：
1. 满足所有功能需求（JSON、GIS）
2. 开源免费，符合成本预算
3. 团队有经验，学习成本低
4. 社区活跃，问题容易解决

## 实施计划
- Week 1-2: 搭建 PostgreSQL 集群（主从复制）
- Week 3-4: 数据建模和迁移
- Week 5-6: 性能测试和优化
- Week 7: 上线

## 影响
- ✅ 降低数据库成本约 50 万/年
- ✅ 满足 JSON 和 GIS 功能需求
- ⚠️ 需要学习 PostgreSQL 特有的运维知识

**验证标准**：
- [ ] 性能测试达到 5000 TPS
- [ ] 数据迁移无错误
- [ ] 监控告警配置完成
```

## 9. 与其他规约的关系

- **架构文档**: 参考 `architecture-lightweight.mdc` 和 `module-design-guidelines.mdc`
- **文档规范**: 遵循 `document.mdc` 的通用文档要求
- **工作流程**: 结合 `workflow.mdc` 的决策流程

---

**重要提示**：ADR 是团队智慧的沉淀，不要因为怕麻烦而跳过记录。好的 ADR 是未来的你和团队成员的最佳伙伴！
