---
description: Module design engineering practices guide (模块设计工程实践指南)
globs: []
alwaysApply: false
---
最近更新: 2025-10-28
最近审阅: 2025-10-28
# 模块设计工程实践指南

> **文件编码**：UTF-8, 无 BOM
> 
> **本文档内容**：第16-24章 - 工程实践指南

## 📚 文档导航

| 文档 | 内容 |
|------|------|
| 📖 [主文档](./module-design-guidelines.mdc) | 核心设计原则、文档概述、七要素框架 |
| 📘 [七要素详细规范](./module-seven-elements.mdc) | 第3-9章：背景、角色、模型、流程、状态、接口、数据 |
| 📙 [质量保障指南](./module-quality-assurance.mdc) | 第10-15章：NFR、监控、安全、风险 |
| 📕 **当前文档** | 第16-24章：技术债、评审、演进、快速指南 |

---

## 16. 技术债管理

### 16.1 技术债记录表
| 技术债ID | 类别 | 描述 | 影响范围 | 严重程度 | 记录日期 | 计划清理版本 | 负责人 |
|----------|------|------|----------|----------|----------|--------------|--------|
| TD-001 | 性能 | 未实现批量查询优化 | 查询接口 | 中 | 2025-10-01 | v2.0 | @张三 |
| TD-002 | 安全 | 缺少敏感数据加密 | 数据存储 | 高 | 2025-10-05 | v1.1 | @李四 |

### 16.2 技术债管理原则
- **记录透明**：所有已知技术债都应记录在案
- **优先级评估**：根据影响范围和严重程度确定优先级
- **定期审查**：每个迭代评审技术债清单
- **主动清理**：预留 20% 迭代时间用于清理技术债
- **防止累积**：新增技术债必须说明原因和清理计划

---

## 17. 裁剪准则与模板定制

### 17.1 MVP 最小集
**必选章节**（任何模块设计都必须包含）：
- 第0章：核心设计原则（至少阅读）
- 第3章：背景与目标
- 第5章：模型与不变量
- 第8章：接口与事件契约
- 第9章：数据存储设计

**可选章节**（根据复杂度裁剪）：
- 第4章：角色与用例（简单CRUD可省略）
- 第6章：流程与时序（无复杂流程可省略）
- 第7章：状态机（无状态转换可省略）
- 第10-16章：根据实际需求选择

### 17.2 裁剪决策流程
```mermaid
flowchart TD
    Start([开始设计]) --> Q1{是否有复杂<br>业务流程?}
    Q1 -->|是| KeepFlow[保留第4/6章]
    Q1 -->|否| SkipFlow[可省略第4/6章]
    
    KeepFlow --> Q2{是否有<br>状态转换?}
    SkipFlow --> Q2
    Q2 -->|是| KeepState[保留第7章]
    Q2 -->|否| SkipState[可省略第7章]
    
    KeepState --> Q3{是否有严格<br>NFR要求?}
    SkipState --> Q3
    Q3 -->|是| KeepNFR[保留第10-13章]
    Q3 -->|否| SkipNFR[简化第10-13章]
    
    KeepNFR --> Q4{是否需要<br>数据迁移?}
    SkipNFR --> Q4
    Q4 -->|是| KeepMigration[保留第14章]
    Q4 -->|否| SkipMigration[可省略第14章]
    
    KeepMigration --> MVP[生成MVP文档]
    SkipMigration --> MVP
    
    style Start fill:#e0f2fe
    style MVP fill:#86efac
```

### 17.3 与系统架构章节映射
| 模块文档章节 | 系统架构对应章节 | 关系 | 是否可裁剪 |
|-------------|-----------------|------|-----------|
| 第0章 核心设计原则 | 系统级设计原则 | 遵循 | ❌ 必读 |
| 第3章 背景与目标 | 系统目标与范围 | 对齐 | ❌ 必填 |
| 第5章 模型与不变量 | 领域模型 | 细化 | ❌ 必填 |
| 第8章 接口契约 | API规范 | 实现 | ❌ 必填 |
| 第9章 数据存储 | 数据架构 | 实例化 | ❌ 必填 |
| 第4章 角色与用例 | 用户旅程 | 细化 | ✅ 简单功能可省略 |
| 第6章 流程与时序 | 系统交互图 | 细化 | ✅ 无复杂流程可省略 |
| 第7章 状态机 | 生命周期管理 | 细化 | ✅ 无状态转换可省略 |
| 第10-13章 质量属性 | NFR规范 | 继承+补充 | ✅ 可简化 |
| 第14章 迁移策略 | 发布策略 | 实例化 | ✅ 新模块可省略 |

### 17.4 裁剪示例模板
当某章节不适用时，请保留章节标题并说明原因：

```markdown
## 7. 状态机设计（要素五）

**本模块不需要状态机设计，原因如下：**
- 本模块为纯查询服务，不涉及实体状态变更
- 数据从上游系统同步，状态管理由上游负责
- 参考上游系统状态定义：`order-service/docs/state-machine.md`

**如果未来需要状态管理，请参考：**
- [七要素详细规范](./module-seven-elements.mdc)第7.1节 状态机设计原则
- `architecture-guidelines.mdc` 第X章 状态管理规范
```

---

## 18. 文档自检清单

### 18.1 完整性检查
- [ ] 所有必选章节是否填写？（第0, 3, 5, 8, 9章）
- [ ] 裁剪的章节是否说明了原因？
- [ ] 是否有 Mermaid 图表支撑？
- [ ] 是否标注了参考文档链接？
- [ ] 是否填写了文档修订历史？

### 18.2 质量检查
**图表质量**：
- [ ] 类图是否明确标注了聚合根、实体、值对象？
- [ ] 时序图是否覆盖主成功路径和异常分支？
- [ ] 状态机是否标注了守卫条件？
- [ ] 流程图是否有决策点和异常处理？

**表格质量**：
- [ ] API 契约表是否包含错误码范围、幂等键、SLA？
- [ ] 事件契约表是否包含重试策略、幂等字段？
- [ ] 索引设计表是否包含查询模式分析？

**术语一致性**：
- [ ] 实体命名是否与代码一致？
- [ ] 事件命名是否使用过去时？
- [ ] 术语是否在全文中保持一致？

### 18.3 可读性检查
- [ ] 是否有过多的专业术语未解释？
- [ ] 是否有冗长的段落（建议用列表或表格）？
- [ ] 是否有示例代码或配置片段？
- [ ] 是否有"为什么"的设计决策说明？

---

## 19. 设计反模式（Anti-patterns）

### 19.1 常见文档问题
| 反模式 | 问题 | 正确做法 |
|--------|------|----------|
| **复制粘贴架构文档** | 模块文档与系统架构重复 | 引用系统架构，只写模块特有内容 |
| **缺少图表** | 纯文字描述，难以理解 | 使用 Mermaid 图表表达结构和流程 |
| **过度设计** | 简单 CRUD 写了 50 页文档 | 根据复杂度裁剪，MVP 最小集即可 |
| **术语不一致** | 文档中 Order/订单/工单混用 | 统一术语，必要时提供术语表 |
| **缺少示例** | 只有抽象描述，无具体示例 | 提供请求/响应示例、SQL 示例 |
| **版本不更新** | 文档与代码不一致 | 代码变更后及时更新文档 |

### 19.2 常见设计问题
| 反模式 | 问题 | 正确做法 |
|--------|------|----------|
| **上帝聚合** | 聚合包含 10+ 个实体 | 拆分聚合，保持 ≤3 层深度 |
| **跨聚合事务** | 一个事务修改多个聚合根 | 使用最终一致性和事件驱动 |
| **缺少幂等性** | POST 接口无幂等键 | 使用 `Idempotency-Key` 或业务唯一键 |
| **无状态守卫** | 状态随意转换 | 定义守卫条件和转换规则 |
| **同步强依赖** | 同步调用 5+ 个下游服务 | 异步化或缓存数据 |
| **缺少监控** | 无关键指标和告警 | 定义 RED/USE 指标和告警阈值 |

---

## 20. 文档引用与协作规范

### 20.1 与其他文档的关系
- **系统架构文档**：`docs/architecture.md` - 系统级设计原则和技术栈
- **ADR 文档**：`docs/adr/` - 架构决策记录
- **可观测性规范**：`docs/ops/observability.md` - 日志、指标、追踪规范
- **安全规范**：`docs/security/security-guidelines.md` - 认证、授权、加密规范

### 20.2 文档引用规范
| 内容类型 | 如何处理 | 示例 |
|----------|----------|------|
| **系统级规范** | 引用，不复制 | 见 `architecture.md` 第3章 |
| **通用原则** | 引用+补充模块特有部分 | 参考 `architecture.md` API规范，本模块额外要求... |
| **模块特有设计** | 详细描述 | 本模块的结算聚合设计... |
| **第三方文档** | 外链 | 参考 [DDD 聚合设计](https://example.com) |

### 20.3 引用写法示例
```markdown
## 8. 接口与事件契约

### 8.1 通用 API 规范
**继承系统级规范**：本模块遵循 [`docs/architecture.md` 第5章 API设计规范](../architecture.md#5-api设计规范)

**模块特有规范**：
- 错误码范围：`51000-51999`（结算模块专用）
- 幂等键：使用 `settlement-batch-no` 作为业务幂等键
- 限流策略：批次创建接口限流 10/min/merchant
```

### 20.4 省略写法示例
```markdown
## 10. 非功能性需求 (NFR)

**继承系统级 NFR**：本模块遵循 [`docs/architecture.md` 第7章 NFR规范](../architecture.md#7-nfr规范)

**模块特有 NFR**：
| 维度 | 目标 | 理由 |
|------|------|------|
| 性能 | P95 < 500ms | 批量计算场景，可接受更长延迟 |
| 一致性 | 最终一致 < 5min | 结算非实时，允许短时间不一致 |
```

### 20.5 冲突处理
当模块设计与系统架构冲突时：
1. **优先遵循系统架构**：如无特殊原因，应遵循系统级规范
2. **提出 ADR**：如需偏离系统规范，应撰写 ADR 说明原因
3. **记录例外**：在模块文档中明确标注例外情况

示例：
```markdown
> ⚠️ **例外说明**：本模块使用悲观锁而非系统推荐的乐观锁，原因：
> - 结算批次冲突率高（>30%），乐观锁重试成本高
> - 详见 ADR-042: Settlement Batch Locking Strategy
```

---

## 21. 评审流程

### 21.1 评审阶段
```mermaid
graph LR
    A[设计者提交] --> B[自检清单]
    B --> C[领域专家评审]
    C --> D[技术架构评审]
    D --> E[安全评审]
    E --> F{是否通过?}
    F -->|是| G[发布文档]
    F -->|否| H[修订]
    H --> B
    
    style A fill:#e0f2fe
    style G fill:#86efac
    style H fill:#fca5a5
```

### 21.2 评审角色与关注点
| 角色 | 关注点 | 使用工具 |
|------|--------|----------|
| **设计者** | 文档完整性和质量 | 第18章 自检清单 |
| **领域专家** | 业务逻辑正确性 | [七要素详细规范](./module-seven-elements.mdc)第5章 模型、第7章 状态机 |
| **技术架构师** | 架构原则遵循性 | [主文档](./module-design-guidelines.mdc)第0章 设计原则、[七要素详细规范](./module-seven-elements.mdc)第9章 数据设计 |
| **安全专家** | 安全风险 | [质量保障指南](./module-quality-assurance.mdc)第13章 安全控制 |
| **运维/SRE** | 可运维性 | [质量保障指南](./module-quality-assurance.mdc)第12章 可观测性、第14章 发布策略 |

### 21.3 评审检查清单
**使用第18章自检清单作为基础，额外关注：**
- [ ] 是否有明显的设计反模式？（参考第19章）
- [ ] 是否与系统架构冲突？（参考第20章）
- [ ] 是否有未缓解的高风险？（参考[质量保障指南](./module-quality-assurance.mdc)第15章）
- [ ] 是否有计划的技术债？（参考第16章）

### 21.4 反馈迭代规则
- **迭代轮次**：最多 3 轮评审，第 3 轮必须给出明确结论
- **响应时间**：设计者应在 2 个工作日内响应评审意见
- **阻塞条件**：以下问题必须解决才能通过：
  - 违反系统级设计原则（无 ADR 说明）
  - 存在高风险安全问题
  - 缺少关键章节（第0, 3, 5, 8, 9章）
- **非阻塞建议**：优化建议可记录为技术债，后续迭代优化

**评审通过标准**：
- ✅ 所有阻塞问题已解决
- ✅ 至少 2 位评审者批准
- ✅ 技术债已记录在第16章

---

## 22. 版本演进路线

### 22.1 演进规划模板
```mermaid
timeline
    title 模块演进路线图
    section v1.0 MVP (2025-Q1)
      核心结算功能: 单一租户
                  : 手动触发
                  : 基础监控
    section v1.5 增强 (2025-Q2)
      自动化: 定时任务
            : 多租户支持
            : 完整监控
    section v2.0 扩展 (2025-Q3)
      高级功能: 分布式结算
              : 实时对账
              : 智能重试
    section v2.5 优化 (2025-Q4)
      性能优化: 并行处理
              : 缓存优化
              : 清理技术债
```

### 22.2 演进填写规则
每个版本升级应包含：
- **功能变更**：新增/修改/废弃的功能
- **API 变更**：向后兼容/破坏性变更
- **数据变更**：表结构变更/迁移脚本
- **配置变更**：新增/修改的配置项
- **依赖变更**：升级的依赖库
- **技术债清理**：本版本清理的技术债

### 22.3 示例
```markdown
## v1.5 演进计划（2025-Q2）

### 功能变更
- ✅ 新增：多租户支持
- ✅ 新增：定时任务调度
- ⚠️ 修改：批次查询接口支持租户隔离
- ❌ 废弃：`GET /batches` 接口（使用 `GET /tenants/{id}/batches` 代替）

### API 变更
**向后兼容**：
- 所有 API 增加 `X-Tenant-ID` header
- 旧接口保留，标记 `@Deprecated`，v2.0 移除

**破坏性变更**：无

### 数据变更
- 新增表：`tenant_config`
- 修改表：`settlement_batch` 增加 `tenant_id` 列
- 迁移脚本：`migrations/v1.5/001_add_tenant_id.sql`

### 技术债清理
- TD-003：优化批量查询性能（完成）
- TD-005：补充集成测试（完成）
```

### 22.4 破坏性变更处理
**定义**：破坏性变更指会导致现有客户端无法正常工作的变更，例如：
- 删除或重命名 API 接口
- 删除或重命名请求/响应字段
- 修改字段类型或验证规则
- 修改错误码含义

**处理流程**：
1. **提前公告**（N+1 版本）：在文档和 API 响应中标记 `deprecated`
2. **多版本并存**（N+2 版本）：旧版本和新版本同时提供
3. **强制升级通知**（N+3 版本）：邮件/公告通知用户迁移
4. **移除旧版本**（N+3 版本）：确认无客户端使用后移除

**示例**：
```markdown
## v2.0 破坏性变更

### 废弃接口
- `GET /batches`（废弃于 v1.5，移除于 v2.0）
  - **替代方案**：使用 `GET /tenants/{id}/batches`
  - **迁移指南**：[docs/migration/v1.5-to-v2.0.md](../migration/v1.5-to-v2.0.md)

### 客户端影响分析
| 客户端 | 是否使用废弃接口 | 迁移状态 | 负责人 |
|--------|-----------------|----------|--------|
| Web 前端 | 是 | 已迁移 | @张三 |
| Mobile App | 否 | 无需迁移 | - |
| 第三方集成 | 是 | 迁移中 | @李四 |
```

---

## 23. 快速填写指南（Cheat Sheet）

### 23.1 各章节快速提示
| 章节 | 核心问题 | 常见遗漏 | 推荐时间 |
|------|----------|----------|----------|
| **第3章 背景与目标** | 为什么做？做什么？ | 非目标、度量指标 | 30分钟 |
| **第4章 角色与用例** | 谁用？怎么用？ | 异常分支、后置条件 | 1小时 |
| **第5章 模型与不变量** | 核心概念？约束？ | 值对象识别、不变量代码体现 | 2小时 |
| **第6章 流程与时序** | 如何交互？ | 异常流程、并发处理 | 2小时 |
| **第7章 状态机** | 状态如何转换？ | 守卫条件、不可逆状态 | 1.5小时 |
| **第8章 接口契约** | 如何暴露？ | 幂等键、错误码范围、SLA | 2小时 |
| **第9章 数据存储** | 如何存储？ | 索引分析、分区策略 | 1.5小时 |
| **第10-13章 质量** | NFR/监控/安全？ | 告警阈值、权限矩阵 | 1小时 |
| **第14-15章 风险** | 如何上线？风险？ | 回滚条件、缓解措施 | 1小时 |
| **第16章 技术债** | 已知问题？ | 技术债优先级 | 30分钟 |

### 23.2 快速开始模板
**MVP 最小可行文档**（新人 4 小时完成）：
1. 第0章：阅读设计原则（不需要填写）
2. 第3章：背景与目标（必填）
3. 第5章：画类图，写不变量（必填）
4. 第8章：API 契约表（必填）
5. 第9章：表结构+索引（必填）

**完整文档**（经验者 2 天完成）：
- MVP + 第4, 6, 7章（流程和状态）
- 第10-16章（质量属性）
- 第17-24章（工程实践）

### 23.3 常用 Mermaid 模板

**时序图模板**：
```mermaid
sequenceDiagram
    participant A as 客户端
    participant B as API
    participant C as 服务
    participant D as 数据库
    A->>B: 请求
    B->>C: 验证
    C->>D: 查询
    D-->>C: 结果
    C-->>B: 响应
    B-->>A: 返回
```

**状态机模板**：
```mermaid
stateDiagram-v2
    [*] --> 初始状态
    初始状态 --> 处理中 : 事件1
    处理中 --> 完成 : 事件2
    处理中 --> 失败 : 错误
    失败 --> [*]
    完成 --> [*]
```

**类图模板**：
```mermaid
classDiagram
    class 聚合根 {
        <<AggregateRoot>>
        +Long id
        +业务方法()
        -checkInvariant()
    }
    class 实体 {
        <<Entity>>
        +Long id
    }
    class 值对象 {
        <<ValueObject>>
        +属性
    }
    聚合根 "1" *-- "*" 实体
    聚合根 --> 值对象
```

---

## 24. 附录

### 24.1 术语表
> 请在这里补充模块特有术语

| 术语 | 英文 | 定义 | 示例 |
|------|------|------|------|
| 结算批次 | Settlement Batch | 一次结算周期内的所有结算明细集合 | 2025-01 月度结算批次 |
| 商家 | Merchant | 参与结算的业务主体 | 商家ID: M12345 |

### 24.2 参考文档
- [系统架构文档](../architecture.md)
- [DDD 参考指南](https://domain-driven-design.org/)
- [RESTful API 设计指南](https://restfulapi.net/)
- [数据库设计规范](../database-guidelines.md)

### 24.3 示例与PoC结果
> 补充性能测试结果、原型验证结果等

### 24.4 变更记录
| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-10-01 | 初始版本 | @张三 |
| v1.1 | 2025-10-15 | 新增多租户支持 | @李四 |

---

## 文档修订历史

- **2025-10-28**：从主文档拆分独立
  - 包含第16-24章：工程实践指南
  - 添加文档导航和跨文档引用
